\chapter{Diseño e Ingeniería}

\pagestyle{empty}

\newpage

\pagestyle{fancy}

\section{Planificación}

Para poder llevar a cabo el desarrollo del proyecto debemos plantearnos una serie de objetivos en un tiempo determinado. Todo esto ayudará a definir las distintas etapas de investigación y desarrollo para lograr un orden y cumplir con los plazos de entrega.

\subsection{Metodologías de trabajo}

\subsubsection{Kanban}

Kanban es una forma de ayudar a los equipos a encontrar un equilibrio entre el trabajo que necesitan hacer y la disponibilidad de cada miembro del equipo. La metodología Kanban se basa en una filosofía centrada en la mejora continua, donde las tareas se representan en una lista de acciones pendientes en un flujo de trabajo constante. \\

La metodología Kanban se implementa por medio de tableros Kanban. Se trata de un método visual de gestión de proyectos que permite a los equipos visualizar sus flujos de trabajo y la carga de trabajo. En un tablero Kanban, el trabajo se muestra en un proyecto en forma de tablero organizado por columnas. \\

Para esto se utilizó el panel de Project Management de GitHub que es gratis y muy completo, además de integrarse con el desarrollo de software.

\begin{figure}[H]
    \centering
    \includegraphics[scale=.28]{src/imagenes/metodologias/kanban.png}
    \caption{Panel de gestión de proyecto en GitHub.}
\end{figure}

\subsubsection{Waterfall}

Esta metodología es una aproximación lineal al desarrollo y ha sido la más utilizada durante los últimos 30 años. La secuencia que sigue este método está compuesta de las siguientes fases:

\begin{itemize}
    \item{Captura y documentación de requisitos.}
    \item{Diseño.}
    \item{Desarrollo.}
    \item{Test.}
    \item{Corrección de errores y ajustes finales.}
    \item{Puesta en producción.}
\end{itemize}

En un desarrollo waterfall puro, cada una de estas fases representan una etapa diferenciada en el desarrollo del producto final. Cada una de estas etapas deben darse por concluidas antes de comenzar con la siguiente. Además, entre cada una de ellas, generalmente tenemos un hito bloqueante que nos impide avanzar a la siguiente si este no se libera adecuadamente.

\subsection{Tareas a realizar}

El desarrollo de este proyecto se divide en 4 grandes etapas:

\begin{enumerate}
    \item{Desarrollo del modelo del sistema.}
    \item{Diseño del hardware de control.}
    \begin{enumerate}
        \item{Actuadores de potencia.}
        \item{Electrónica del controlador.}
        \item{Electrónica transductora.}
        \item{Conexiones clableadas.}
    \end{enumerate}
    \item{Diseño del software de control.}
    \begin{enumerate}
        \item{Controlador.}
        \item{Pantallas de visualización y configuración.}
        \item{Simulación de la pileta.}
        \item{Infraestructura de red.}
        \item{Configuración del servidor de métricas.}
    \end{enumerate}
    \item{Elavoración del prototipo.}
    \begin{enumerate}
        \item{Limitaciones.}
        \item{Contrucción.}
    \end{enumerate}
\end{enumerate}

Todas las actividades son desarroladas secuencialmente utilizando la metodología de waterfall. Unicamente en la etapa de diseño de software se utilizará un enfoque pararelo tipo scrum.

\subsection{Tiempos de desarrollo}

Llevar cabo un desarrollo completo del sistema se extiende un poco, mas si tenemos en cuenta que lo realizan dos Ingenieros Junior. Con esto en cuenta, consideramos los siguientes plazos:

\begin{figure}[H]
    \centering
    \includegraphics[scale=.35]{src/imagenes/ingenieria/lineaDeTiempo.png}
\end{figure}

Resumiendo el esquema, se estipula un tiempo de desarrollo de 10 meses aproximadamente.

\section{Diseño y desarrollo}

De manera muy simplificada, se puede ver el sistema de control como la siguiente figura:

\begin{figure}[H]
    \centering
    \includegraphics[scale=.45]{src/imagenes/ingenieria/controlador.png}
\end{figure}

\subsection{Modelado del sistema}

\subsubsection{Sistema de aireación}

Es sistema de aireación esta compuesto por la etapa de suministro de aire, de distribución de aire y expulsión de aire. Podrá ver una descripción mas detallada en el anexo \ref{anexo:caracteristicasDelSistema}. \\

El aporte de oxígeno es producido por un soplador de lóbulos rotativos de la marca \href{https://repicky.com.ar/site/}{Repicky}, accionando mediante un motor trifásico con variador, permitiendo regular el caudal de aire en función a la frecuencia. Al circular este caudal en el interior de una grilla de aireación, ubicada en la parte inferior de la pileta, se genera una presión en el sistema de distribución provocando que el aire ingrese a la pileta y se transfiera al líquido.

\begin{figure}[H]
    \centering
    \includegraphics[scale=.45]{src/imagenes/sistema/caracteristicasConstructivas.png}
    \caption{Sistema de suministro de aire.}
\end{figure}

Para distribuir el aire de manera uniforme a travez de la pileta de aireación, la planta de tratamiento tiene una grilla de cañerias de diametro mas fino.

\begin{figure}[H]
    \centering
    \includegraphics[scale=.35]{src/imagenes/sistema/diagramaRegillasInventor.png}
    \caption{Sistema de distribución de aire.}
\end{figure}

Por último al llegar a los difusores (orificios pequeños en las cañerias), el aire forma burbujas que son expulsadas al líquido para producir la difusión del oxígeno al agua.

\begin{figure}[H]
    \centering
    \includegraphics[scale=.35]{src/imagenes/sistema/tuberias2.png}
    \caption{Sistema de expulsión de aire.}
\end{figure}

Se realizó la simulación del sistema en \href{https://fluidflowinfo.com/}{FLUIDFLOW}, se pudo observar cómo cambia el caudal de ingreso de aire en función a la velocidad de operación del soplador (RPM), y como se distribuye el mismo en cada sección de cañería. \\

El objetivo principal del análisis era determinar qué frecuencia mínima del variador nos garantiza el ingreso de aire a la pileta de lodos activos (parámetro que es muy complejo para determinar de manera analítica). Sin embargo los resultados que se obtubieron no fueron concluyentes. Esto nos indica que el ajuste final del sistema se deberá realizar de manera empírica con una serie de pruebas en condiciones controladas.

\subsubsection{Variables del sistema}

Actualmente la planta de tratamiento de efluentes esta sensando:

\begin{itemize}
    \item{Nivel de PH en la zona anóxica y en la pileta de aireación.}
    \item{Nivel de foso en la zona anóxica.}
    \item{Nivel de OD en la pileta de aireación.}
    \item{Temperatura en la zona de aireación (aunque este parámetro no se visualiza en el SCADA de la planta).}
\end{itemize}

Para que nuestro sistema de control pueda funcionar, es necesario disponer del nivel de OD, temperatura y PH de la pileta de aireación. Aunque para el servidor de métricas se capturen todas las variables anteriormente mencionadas. \\

Para mas información acerca del OD y el sensor de OD, puede ver el anexo \ref{anexo:oxigenoDisuelto}.

\subsection{Controlador}

El controlador de la pileta de aireación, es quien captura las variables críticas del sistema y provoca una variación de frecuencia en los motores de los sopladores, produciendo asi, un cambio en cantidad de oxígeno insuflado al agua. \\

Una consideración importante, tiene que ver con la forma de conocer el valor de la DBO, como se describió anteriormente, se realiza mediante ensayos de laboratorio. Sin embargo, aún se puede establecer manualmente una serie de parámetros en el proceso que estén controlados por el sistema, pero que se determinen de forma manual. Es decir, se genera un setpoint de concentración de oxígeno disuelto en función a los valores de DBO obtenidos en el análisis. Esto provoca que el sistema de control, consista en mantener una concentración de oxígeno disuelto (OD) constante igual al setpoint en función a los valores de OD arrojados por el sensor, independientemente de la temperatura y el flujo de entrada y salida. \\

Por otro lado, el tiempo de respuesta entre un cambio de caudal de aire estrangulado y el nivel de OD, es muy lento. Aproximadamente toma una hora o más para que haya una variación en el nivel del sensor. Esto plantea un sistema de control con un tiempo de respuesta muy lento.

\subsubsection{Aproximación del sistema}

Al no conocer con exactitud el modelo matemático del sistema, ni como este responde ante diferentes entradas, se aproximo una relación de variación del OD en función al caudal de aire de ingreso. Esta aproximación nos permitió el desarrollo de un controlador ajustable para distintos modos de operación. Puede leer mas en anexo \ref{anexo:aproximacionDelSistema}.

\subsubsection{Controlador PID}

El controlador es el encargado de comparar la variable de proceso medida con un valor de referencia de entrada (set point), para determinar la desviación y producir una señal de control que reduzca ese error a un valor aproximado a cero. La manera en la cual el controlador ejecuta la señal de control se denomina acción de control, es la cantidad dosificada de energía que afecta al sistema para producir la salida o la respuesta deseada. \\

En nuestro caso, el controlador detecta la señal de error, comparando el set point seteado en relación al valor de OD. La acción de control, es generar una salida en valor de frecuencia al variador.

\begin{figure}[H]
    \centering
    \includegraphics[scale=.38]{src/imagenes/sistema/pid.png}
    \caption{Diagrama de bloques del sistema.}
\end{figure}

En donde:

\begin{itemize}
    \item{$r(t)$: entrada de referencia.}
    \item{$e(t)$: señal de error.}
    \item{$v(t)$: variable regulada.}
    \item{$m(t)$: variable manipulada.}
    \item{$p(t)$: señal de perturbación.}
    \item{$y(t)$: variable controlada.}
    \item{$b(t)$: variable de retroalimentación como resultado de haber detectado la variable controlada por medio del sensor.}
\end{itemize}

Como en todo sistema de control, la salida de este, es la entrada al actuador, quien efectúa la acción de control. En nuestro caso en particular, el actuador es un variador de frecuencia controlado mediante sus entradas digitales, lo que genera que se tenga que considerar dos aspectos fundamentales. \\

El primero es la rampa de aceleración propia del variador. Para una salida del controlador en RPM, se debe convertir a un valor en frecuencia, que luego se transfiere al variador. Este, genera una rampa de aceleración entre el valor actual y el del controlador. Se tiene como dato que la rampa va de 0 a RPMmax en 20s. La consideración de la rampa de aceleración del variador es indispensable para la simulación posterior. \\

El segundo, es la transferencia del valor en frecuencia al variador, como ya se menciono se utilizan las 4 entradas digitales. Tenemos entonces, $2^{4}=16$ estados posibles. Además, si consideramos que tenemos 60Hz se generan saltos discretos de 4Hz. Esto provoca, que se pierda precisión en el controlador. Si una acción de control cae en el intervalo no definido, se tiene que optar por aproximarla al valor más cercano. \\

Como ecuación para el controlador utilizamos:

$$e(t) = Kp \cdot e(t) + Ki \sum_{i=1}^{n} e(t_{i}) + Kd \cdot \frac{e(t + h) - e(t)}{h}$$

El proceso para el cálculo de la ecuación que modela el controlador se encuentra en el anexo \ref{anexo:controlPID}.

\subsection{Diseño eléctrico}

\subsubsection{Diseño de la instalación}

En el diseño del circuito eléctrico, se considera una disposición para la conexión de los motores, en la cual tenemos un circuito de distribución principal al que se conecta el circuito terminal del motor.

\begin{figure}[H]
    \centering
    \includegraphics[scale=.6]{src/imagenes/ingenieria/layout.png}
\end{figure}

Para el diseño de la etapa de potencia del sistema de control, se tienen en cuenta los siguientes aspectos:

\begin{itemize}
    \item{Los contactos entre el motor y el variador deben estar cerrados antes de ejecutar una orden de marcha.}
    \item{La etapa de potencia debe estar desactivada cuando los contactos entre el motor y el variador estén abiertos.}
    \item{El circuito debe activar el arranque directo del motor y desactivar el contacto del variador ante una eventual falla del sistema. Manual con selector.}
    \item{Debe garantizar que nunca se pueda activar ambos contactores de los motores. Un solo motor puede operar.}
    \item{Cuando se presenten fallas, los contactores deben desactivarse. }
\end{itemize}

Los planos y los esquemas finales se encuentran en el anexo \ref{anexo:planosElectricos}. Además el cálculo de conductores esta en el anexo \ref{anexo:calculoConductores}, y el de protecciones en el anexo \ref{anexo:dimensionamientoDeProtecciones}.

\subsubsection{Componentes seleccionados}

\pendiente{Tabla de componentes}

\subsection{Diseño electrónico}

Esta etapa es la mas importante. En ella se encuentra el hardware de control conformado por una Raspberry Pi 3 B+ y electrónica transductora que se encarga de convertir los tipos de señales. Dado que los sistemas de potencia industriales operan de manera estandarizada, nuestro controlador debe ajustarse para respetar dichos estandares. \\

La microcomputadora que opera en el sistema es la \href{https://www.raspberrypi.org/}{Raspberry Pi 3B+}. Esta microcomputadora de bajo consumo, posee pines de entrada y salida que operan con una lógica de 3.3V. Por lo que es necesario realizar una separación de entre el voltaje de operación estandar (24V) y el voltaje de la electrónica de la placa, además de estar aislados galvanicamente. \\

La microcomputadora es la encargada de procesar los datos de los sensores y enviar una respuesta al variador de frecuencia, para así poder controlar la velocidad de los sopladores. Además se encarga de almacenar y enviar los datos de telemetría de todo el proceso al servidor de métricas, para así poder visualizar la información en tiempo real o en un futuro realizar un análisis detallado. \\

Los planos, los esquemas y el ensamble 3D se encuentran en el anexo \ref{anexo:planosElectronicos}.

\subsection{Diseño de software}

Los software desarrollados por nosotros y que intervienen en el sistema estan en los siguientes repositorios de GitHub:

\begin{itemize}
    \item{\href{https://github.com/GabiAndi/UNER_Tesis_Controlador_SCPA}{\textbf{SCPA:}} o Software Controlador de la Planta de Aireación, es ejecutado por la microcomputadora y es el encargado de generar una salida para el variador de frecuencia en función a la acción correctiva adoptada por el PID, de capturar los datos provenientes de los sensores, de transmitir la telemetría al servidor de métricas y de proporcionar una API de configuración del sistema.}
    \item{\href{https://github.com/GabiAndi/UNER_Tesis_GUI_SCPA}{\textbf{GUI:}} o Interfaz de Operación, proporciona un acceso visual al estado de la planta y permite configurar los parámetros del controlador del sistema.}
    \item{\href{https://github.com/GabiAndi/UNER_Tesis_HMIProtocol}{\textbf{Protocolo de comunicación:}} es el protocolo adoptado para la comunicación entre el \textit{SCPA} y la \textit{GUI}.}
    \item{\href{https://github.com/GabiAndi/UNER_Tesis_SCPA}{\textbf{SIMOD:}} es un script de Python encargado de simular el comportamiento de la planta de tratamiento de efluentes.}
\end{itemize}

Exceptuando a \textit{SIMOD}, el resto de los programas fueron desarrolados con el Framework de Qt, que es multiplataforma y ademas esta escrito en C++ que es un leguaje de sistemas. \\

La configuración de la Raspberry Pi y el entorno de desarrollo se encuentra en el anexo \ref{anexo:configuracionDeLaRaspberry}.

\subsubsection{Controlador del sistema}

El programa que proporciona el control del sistema de aireación se desarrollo pensando en saparar en distintos hilos de ejecución las distintas partes de código que realicen tareas independientes y posean alguna acción bloqueante. Esto proporciona una mejor respuesta ante fallas inesperadas, como lo pueden ser el bloqueo de alguna tarea de comunicación o la captura de datos por consola. \\

El \textit{SCPA} posee la siguiente estructura de clases:

\begin{figure}[H]
    \centering
    \includegraphics[scale=.4]{src/imagenes/ingenieria/softwareSCPA.png}
    \caption{Diagrama de clases simplificado.}
\end{figure}

En donde:

\begin{itemize}
    \item{\textbf{SCPAManager:} es la clase principal del programa, en donde se crean todos los hilos de ejecución para las tareas correspondientes y se administran los recursos de memoria.}
    \item{\textbf{TUIManager:} viene de Text User Interface, y como su nombre lo indica, proporciona una interfaz de control de consola que es solamente accesible por el S.O. de la microcomputadora. Permite la configuración con privilegios administrativos de todo el sistema.}
    \item{\textbf{ControlManager:} es la clase encargada de realizar el control PID y de enviar la salida del mismo al variador de frecuencia.}
    \item{\textbf{HMIServerManager:} proporciona un servicio de panel administrativo via TCP/IP por el puerto 33600.}
    \item{\textbf{MetricsManager:} clase que administra todas las métricas del sistema y las envia a las distintas bases de datos que corre el servidor de métricas.}
\end{itemize}

\textbf{En azul} se encuentra el punto de entrada de la aplicación, \textbf{en verde} la clase principal, \textbf{en amarillo} los distintos hils de ejecución, \textbf{en rojo} los eventos bloqueantes y \textbf{en morado} los logsfiles. Los logfiles son archivos que el programa escribe indicando la ocurrencia de algún evento de posible interes por un administrador.

\subsubsection{Interfaz de operación}

Proporciona una interfaz de administración y monitorización fácil de utilizar, permite al operario la configuración de los parámetros del proceso desde prácticamente cualquier dispositivo conectado a internet. \\

La idea de la interfaz de usuario es que proporcione una ayuda visual para el operario a cargo del control del sistema, mas alla de la manipulación de los parámetros de control y la visualización de la planta. Debe permitir el ajuste del controlador PID de la manera mas intuitiva posible. \\

Dentro de las medidas de seguridad se contempla lo siguiente:

\begin{itemize}
    \item{No permitir que el operario establezca una configuración que podría dañar al sistema eléctrico o mecánico.}
    \item{Proporcionar el acceso a operarios que estén datos de alta (sistema de usuarios).}
    \item{Proporcionar acceso al sistema operativo al administrador o encargado experto (esta persona tiene que conocer a la perfección el sistema puesto que cualquier acción podría comprometer por completo a todo el equipo).}
    \item{Todo dato que se envié hacia afuera de la industria deberá pasar por la VPN.}
    \item{Para cualquier tipo de administración directa se realizará mediante SSH y contará con un par de llaves cifradas únicas.}
\end{itemize}

Debido a que estamos en presencia de un proceso cuyas variables reaccionan de manera muy lenta, el controlador del sistema funciona de la siguiente manera:

\begin{enumerate}
    \item{Se leen los sensores cada 60 segundos.}
    \item{El controlador realiza el cálculo de la acción correctiva cada 2 horas, ya que para poder detectar un cambio en la pileta de aireación debe pasar como mínimo una hora y media.}
    \item{La rampa de aceleración y desaceleración de los sopladores es bastante lenta. Transcurren 20 min entre el valor mínimo (detenido) y el máximo. Esto es necesario para evitar golpes de ariete y cambios bruscos en la presión a la que se someten las tuberias de distribución.}
    \item{Las métricas del controlador se envían con cada lectura de los sensores. Condición necesaria para tener disponibilidad inmediata de los datos.}
\end{enumerate}

El controlador PID no es capaz de ejercer una acción correctiva continua, debido a las características del propio sistema (saltos en frecuencia, limitaciones de aceleración, tiempos de respuesta muy lentos, etc).

\subsubsection{Protocolo de comunicación}

Para que el controlador pueda realizar su trabajo y logre interactuar con los sistemas subyacentes, es necesario una convención en cuanto a la transmisión y recepción de datos. Esto se debe a que los dispositivos pertenecientes al sistema actual interactúan de manera diferente y utilizan sus propios protocolos de comunicación. \\

La comunicación se realiza mediante el protocolo TCP/IP por puerto 33600 y se incorporó un conjunto de comandos personalizado. Todo este desarrollo se encuentra en anexo \ref{anexo:protocoloDeComunicacion}.

\subsubsection{Simulación del modelo matemático}

Para poder realizar pruebas del sistema de control, es necesario simular la planta de tratamiento de efluentes. Es por ello que todo el modelo matemático y los datos de velocidad de respuesta del sensor OD son cargador en un script de python. \\

El script esta encargado de obtener en tiempo real la ecuación del sistema. Dicho script genera una salida de OD en función a una entrada rampa, que es la aceleración de rpm producida por el variador de velocidad. Puede consultar el anexo \ref{anexo:solucionDeAdaptabilidad}. \\

El esquema completo queda de la siguiente manera:

\newpage

\begin{figure}[H]
    \centering
    \includegraphics[angle=90,scale=.40]{src/imagenes/sistema/esquemaSistemaLA.png}
\end{figure}

\newpage

\section{Prototipado}

\subsection{Limitaciones}

Ya que realizar pruebas directamente en un sistema en funcionamiento es complicado, y construir una pileta de aireación no es una opción, el prototipo fue creado para mostrar las generalidades de funcionamiento de la planta y enfocarse mas en el trabajo del sistema de control, la captura de métricas y la gestión del software.

\subsection{Diseño y desarrollo}

El prototipo se contruyo en la Planta Piloto de la Facultad de Ciencias de Alimentación, utilizando los siguiente componentes:

\begin{itemize}
    \item{Un variador de velocidad de 2kW Micromaster 440 de la marca SIEMENS.}
    \item{Un motor de 1.1kW.}
    \item{Una Raspberry Pi 3B+.}
    \item{Un módulo de 4 reles.}
    \item{Un módulo de 1 rele.}
    \item{Cables DuPont para las conexiones.}
    \item{Una pantalla táctil de 4 pulgadas con resolución 800x600.}
    \item{Una computadora de escritorio con mouse y teclado corriendo Debian 11.}
\end{itemize}

\begin{figure}[H]
    \centering
    \includegraphics[angle=-90,scale=.06]{src/imagenes/prototipo/variador.jpg}
    \caption{Variador de velocidad.}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[angle=-180,scale=.06]{src/imagenes/prototipo/motor.jpg}
    \caption{Motor trifásico.}
\end{figure}

\pendiente{Fotos de los módulos rele}

\pendiente{Fotos de la Raspberry Pi}

\pendiente{Fotos de la PC}

El variador de velocidad requiere una configuración determinada para poder funcionar mediante entradas digitales. Además, estas entradas digitales deben tener los saltos de frequencia calculados de $4Hz$. Para poder realizar esta configuración se realizo el siguiente procedimiento con los parámetros del Micromaster 440:

\newpage

\begin{figure}[H]
    \centering
    \includegraphics[scale=.45]{src/imagenes/prototipo/variadorConfiguracion.png}
\end{figure}

\newpage

Ya contruido, el prototipo quedo de la siguiente manera:

\pendiente{Fotos del SCPA}

\pendiente{Fotos del SCADA}

\pendiente{Fotos del SIMOD}

\pendiente{Fotos de Grafana}

\begin{figure}[H]
    \centering
    \includegraphics[angle=-90,scale=.06]{src/imagenes/prototipo/hmi.jpg}
    \caption{Interfaz de operación.}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[angle=-90,scale=.06]{src/imagenes/prototipo/controlDePotencia.jpg}
    \includegraphics[angle=-90,scale=.06]{src/imagenes/prototipo/sistemaCompleto.jpg}
    \caption{Sistema completo.}
\end{figure}

\subsection{Ensayos y conclusiones}